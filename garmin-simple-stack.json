{
    "AWSTemplateFormatVersion": "2010-09-09",
     "Transform": "AWS::Serverless-2016-10-31",
    "Description": "Template for Lambda Sample.",
    "Parameters": {
        "SourceName": {
            "Description": "API Name",
            "Type": "String"
        },
        "ApplicationName": {
            "Description": "Application Name",
            "Type": "String"
        },
        "Env": {
            "Description": "Environment",
            "Type": "String"
        }
    },
    "Resources": {
        "LambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub":"${ApplicationName}${SourceName}LambdaIam${Env}"
                },
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/AWSLambdaExecute",
                    "arn:aws:iam::aws:policy/AmazonS3FullAccess",
                    "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess",
                    "arn:aws:iam::aws:policy/AmazonKinesisFullAccess"
                ],
                "Path": "/"
            }
        },
        "LambdaFunction": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${ApplicationName}${SourceName}SimpleStatistics${Env}"
                },
                "Description": "Lambda Function to pull statistics from Garmin API",
                "Runtime": "python3.12",
                "CodeUri": "lambda/garmin_stats_function",
                "Handler": "lambda_function.lambda_handler",
                "MemorySize": 128,
                "Timeout": 300,
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "config": {
                            "Ref": "Env"
                        }
                    }
                },
                "Layers": [
                    {"Fn::GetAtt": [
                        "LambdaLibsLayer",
                        "Arn"
                    ]}
                ]
            },
            "DependsOn": [
                "LambdaRole",
                "LambdaLibsLayer"
            ]
        },
        "ScheduledRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name" : {
                    "Fn::Sub": "${ApplicationName}${SourceName}EventRule${Env}"
                },
                "Description": "ScheduledRule",
                "ScheduleExpression": "cron(0/30 1-3 * * ? *)",
                "State": "DISABLED",
                "Targets": [{
                    "Arn": { "Fn::GetAtt": ["LambdaFunction", "Arn"] },
                    "Id": "LambdaFunction"
                    }]
                },
            "DependsOn": "LambdaFunction"
            },
        "PermissionForEventsToInvokeLambda": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": { "Ref": "LambdaFunction" },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": { "Fn::GetAtt": ["ScheduledRule", "Arn"] }
            },
            "DependsOn" : "LambdaFunction"
        },
        "LambdaLibsLayer": {
        "Type": "AWS::Serverless::LayerVersion",
        "Properties": {
            "CompatibleRuntimes": [
                "python3.12",
                "python3.11"
            ],
            "ContentUri": "layers/libs",
            "Description": {"Fn::Sub": "Libraries for ${LambdaFunction}"},
            "LayerName": {
                "Fn::Sub": "${ApplicationName}${SourceName}LambaLib${Env}"
            },
            "LicenseInfo": "MIT"
        }
    }
}
}