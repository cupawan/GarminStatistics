{
    "AWSTemplateFormatVersion": "2010-09-09",
     "Transform": "AWS::Serverless-2016-10-31",
    "Description": "Template for Lambda Sample.",
    "Parameters": {
        "SourceName": {
            "Description": "API Name",
            "Type": "String"
        },
        "ApplicationName": {
            "Description": "Application Name",
            "Type": "String"
        },
        "Env": {
            "Description": "Environment",
            "Type": "String"
        },
        "TelegramBotToken": {
            "Description": "TELEGRAM_BOT_TOKEN",
            "Type": "String"
        },
        "TelegramChatIds": {
            "Description": "TELEGRAM_CHAT_IDS",
            "Type": "String"
        },
        "MyGarminPassword": {
            "Description": "MY_GARMIN_PASSWORD",
            "Type": "String"
        },
        "MyEmailAdderess": {
            "Description": "MY_EMAIL_ADDRESS",
            "Type": "String"
        },
        "AwsAccessKey": {
            "Description": "AWS_ACCESS_KEY",
            "Type": "String"
        },
        "AwsSecretAccessKey": {
            "Description": "AWS_SECRET_ACCESS_KEY",
            "Type": "String"
        },
        "AwsS3BucketName": {
            "Description": "AWS_S3_BUCKET_NAME",
            "Type": "String"
        },
        "AwsS3LambdaFolderKey": {
            "Description": "AWS_S3LAMBDA_FOLDER_KEY",
            "Type": "String"
        },
        "AwsS3LambdaGarminFilename": {
            "Description": "AWS_S3LAMBDA_GARMIN_FILENAME",
            "Type": "String"
        },
        "MongoDbConnectionString": {
            "Description": "MONGODB_CONNECTION_STRING",
            "Type": "String"
        },
        "MongoDbDatabase": {
            "Description": "MONGODB_DATABASE",
            "Type": "String"
        },
        "BulletinEmailAdderess": {
            "Description": "BULLETIN_EMAIL_ADDRESS",
            "Type": "String"
        },
        "BulletinEmailAddressAppPassword": {
            "Description": "BULLET_EMAIL_ADDRESS_APP_PASSWORD",
            "Type": "String"
        },
        "RecEmail": {
            "Description": "REC_EMAIL",
            "Type": "String"
        },
        "GoogleApiKey": {
            "Description": "GOOGLE_API_KEY",
            "Type": "String"
        },
        "RunningMapPath": {
            "Description": "RUNNING_MAP_PATH",
            "Type": "String"
        },
        "GoogleMapsApiPath": {
            "Description": "GOOGLE_MAPS_API_PATH",
            "Type": "String"
        }
        
    },
    "Resources": {
        "LambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": {
                    "Fn::Sub":"${ApplicationName}${SourceName}LambdaIam${Env}"
                },
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "sts:AssumeRole"
                            ],
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/AWSLambdaExecute",
                    "arn:aws:iam::aws:policy/AmazonS3FullAccess",
                    "arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess",
                    "arn:aws:iam::aws:policy/AmazonKinesisFullAccess"
                ],
                "Path": "/"
            }
        },
        "LambdaLibsLayer": {
        "Type": "AWS::Serverless::LayerVersion",
        "Properties": {
            "CompatibleRuntimes": [
                "python3.12",
                "python3.11"
            ],
            "ContentUri": "layers/libs",
            "Description": "Libraries for Garmin Statistics Lambda",
            "LayerName": {
                "Fn::Sub": "${ApplicationName}${SourceName}LambaLib${Env}"
            },
            "LicenseInfo": "MIT"
        }
    },
        "LambdaFunction": {
            "Type": "AWS::Serverless::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Sub": "${ApplicationName}${SourceName}SimpleStatistics${Env}"
                },
                "Description": "Lambda Function to pull statistics from Garmin API",
                "Runtime": "python3.12",
                "CodeUri": "lambda/garmin_stats_function",
                "Handler": "lambda_function.lambda_handler",
                "MemorySize": 128,
                "Timeout": 300,
                "Role": {
                    "Fn::GetAtt": [
                        "LambdaRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "config": {
                            "TELEGRAM_BOT_TOKEN": {"Fn::Sub": "${TelegramBotToken}"},
                            "TELEGRAM_CHAT_IDS": {"Fn::Sub": "${TelegramChatIds}"},
                            "MY_GARMIN_PASSWORD": {"Fn::Sub": "${MyGarminPassword}"},
                            "MY_EMAIL_ADDRESS": {"Fn::Sub": "${MyEmailAdderess}"},
                            "AWS_ACCESS_KEY": {"Fn::Sub": "${AwsAccessKey}"},
                            "AWS_SECRET_ACCESS_KEY": {"Fn::Sub": "${AwsSecretAccessKey}"},
                            "AWS_S3_BUCKET_NAME": {"Fn::Sub": "${AwsS3BucketName}"},
                            "AWS_S3LAMBDA_FOLDER_KEY": {"Fn::Sub": "${AwsS3LambdaFolderKey}"},
                            "AWS_S3LAMBDA_GARMIN_FILENAME": {"Fn::Sub": "${AwsS3LambdaGarminFilename}"},
                            "MONGODB_CONNECTION_STRING": {"Fn::Sub": "${MongoDbConnectionString}"},
                            "MONGODB_DATABASE": {"Fn::Sub": "${MongoDbDatabase}"},
                            "BULLETIN_EMAIL_ADDRESS": {"Fn::Sub": "${BulletinEmailAdderess}"},
                            "BULLET_EMAIL_ADDRESS_APP_PASSWORD": {"Fn::Sub": "${BulletinEmailAddressAppPassword}"},
                            "REC_EMAIL": {"Fn::Sub": "${RecEmail}"},
                            "RUNNING_MAP_PATH": {"Fn::Sub": "${RunningMapPath}"},
                            "GOOGLE_API_KEY": {"Fn::Sub": "${GoogleApiKey}"},
                            "GOOGLE_MAPS_API_PATH": {"Fn::Sub": "${GoogleMapsApiPath}"}
                        }
                    }
                },
                "Layers": [
                    {"Fn::GetAtt": [
                        "LambdaLibsLayer",
                        "LayerVersionArn"
                    ]}
                ]
            },
            "DependsOn": [
                "LambdaRole",
                "LambdaLibsLayer"
            ]
        },
        "ScheduledRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Name" : {
                    "Fn::Sub": "${ApplicationName}${SourceName}EventRule${Env}"
                },
                "Description": "ScheduledRule",
                "ScheduleExpression": "cron(0/30 1-3 * * ? *)",
                "State": "DISABLED",
                "Targets": [{
                    "Arn": { "Fn::GetAtt": ["LambdaFunction", "Arn"] },
                    "Id": "LambdaFunction"
                    }]
                },
            "DependsOn": "LambdaFunction"
            },
        "PermissionForEventsToInvokeLambda": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": { "Ref": "LambdaFunction" },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": { "Fn::GetAtt": ["ScheduledRule", "Arn"] }
            },
            "DependsOn" : "LambdaFunction"
        }
}
}